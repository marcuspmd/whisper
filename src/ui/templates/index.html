<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è Whisper Transcriber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .transcription-item {
            background: rgba(255, 255, 255, 0.9);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .audio-level-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .audio-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.2s ease;
            border-radius: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-error { background-color: #ffc107; }

        .language-flag {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .confidence-badge {
            font-size: 0.75em;
        }

        .header-title {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 300;
        }

        .stat-card {
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="main-container p-4">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="header-title">
                    <i class="fas fa-microphone"></i>
                    Whisper Transcriber
                </h1>
                <p class="text-white-50">Transcri√ß√£o de fala em tempo real</p>
            </div>

            <!-- Status e Controles -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="mb-1">
                                        <span id="status-indicator" class="status-indicator status-stopped"></span>
                                        Status: <span id="status-text">Parado</span>
                                    </h6>
                                    <small class="text-muted">Uptime: <span id="uptime">0s</span></small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1">N√≠vel de √Åudio</label>
                                    <div class="audio-level-bar">
                                        <div id="audio-level-fill" class="audio-level-fill" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">
                                        <span id="audio-level-text">0%</span>
                                    </small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button id="clear-btn" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h3 class="text-primary mb-1" id="total-transcriptions">0</h3>
                            <small class="text-muted">Transcri√ß√µes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h3 class="text-success mb-1" id="translation-count">0</h3>
                            <small class="text-muted">Tradu√ß√µes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h3 class="text-info mb-1" id="language-count">0</h3>
                            <small class="text-muted">Idiomas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-1" id="model-name">-</h3>
                            <small class="text-muted">Modelo</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transcri√ß√µes -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i>
                                Transcri√ß√µes Recentes
                                <span class="badge bg-primary ms-2" id="transcription-badge">0</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                            <div id="transcriptions-container">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-microphone-slash fa-2x mb-2"></i>
                                    <p>Aguardando transcri√ß√µes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais
        let lastTranscriptionId = null;

        // Mapeamento de c√≥digos de idioma para flags
        const languageFlags = {
            'en': 'üá∫üá∏', 'pt': 'üáßüá∑', 'es': 'üá™üá∏', 'fr': 'üá´üá∑',
            'de': 'üá©üá™', 'it': 'üáÆüáπ', 'ru': 'üá∑üá∫', 'ja': 'üáØüáµ',
            'ko': 'üá∞üá∑', 'zh': 'üá®üá≥', 'ar': 'üá∏üá¶', 'hi': 'üáÆüá≥',
            'nl': 'üá≥üá±', 'sv': 'üá∏üá™', 'no': 'üá≥üá¥', 'da': 'üá©üá∞',
            'fi': 'üá´üáÆ', 'pl': 'üáµüá±', 'tr': 'üáπüá∑', 'cs': 'üá®üáø'
        };

        // Fun√ß√£o para formatar tempo
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Fun√ß√£o para obter flag do idioma
        function getLanguageFlag(langCode) {
            return languageFlags[langCode] || 'üåê';
        }

        // Fun√ß√£o para criar elemento de transcri√ß√£o
        function createTranscriptionElement(transcription) {
            const confidenceColor = transcription.confidence > 0.8 ? 'success' :
                                   transcription.confidence > 0.6 ? 'warning' : 'danger';

            return `
                <div class="transcription-item" data-id="${transcription.id}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="language-flag">${getLanguageFlag(transcription.language)}</span>
                            <small class="text-muted">${transcription.timestamp}</small>
                            ${transcription.confidence > 0 ?
                                `<span class="badge bg-${confidenceColor} confidence-badge ms-2">
                                    ${Math.round(transcription.confidence * 100)}%
                                </span>` : ''}
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                <i class="fas fa-volume-up"></i> ${Math.round(transcription.audio_level * 100)}%
                            </small>
                        </div>
                    </div>
                    <div class="transcription-text">
                        <strong>Original:</strong> ${transcription.text}
                    </div>
                    ${transcription.translation ?
                        `<div class="translation-text mt-2">
                            <strong>Tradu√ß√£o:</strong>
                            <em class="text-primary">${transcription.translation}</em>
                        </div>` : ''}
                </div>
            `;
        }

        // Fun√ß√£o para atualizar transcri√ß√µes
        async function updateTranscriptions() {
            try {
                const response = await fetch('/api/transcriptions?limit=20');
                const transcriptions = await response.json();

                const container = document.getElementById('transcriptions-container');

                if (transcriptions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-microphone-slash fa-2x mb-2"></i>
                            <p>Aguardando transcri√ß√µes...</p>
                        </div>
                    `;
                    return;
                }

                // Atualiza apenas se h√° novas transcri√ß√µes
                const latestId = transcriptions[transcriptions.length - 1]?.id;
                if (latestId !== lastTranscriptionId) {
                    container.innerHTML = transcriptions
                        .slice().reverse()
                        .map(createTranscriptionElement)
                        .join('');

                    lastTranscriptionId = latestId;

                    // Auto-scroll para o topo
                    container.scrollTop = 0;
                }

                // Atualiza badge
                document.getElementById('transcription-badge').textContent = transcriptions.length;

            } catch (error) {
                console.error('Erro ao atualizar transcri√ß√µes:', error);
            }
        }

        // Fun√ß√£o para atualizar estat√≠sticas
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                // Atualiza elementos
                document.getElementById('total-transcriptions').textContent = stats.total_transcriptions;
                document.getElementById('translation-count').textContent = stats.translation_count;
                document.getElementById('language-count').textContent = Object.keys(stats.languages_detected).length;
                document.getElementById('uptime').textContent = formatUptime(stats.uptime_seconds);

                // Atualiza status
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');

                statusIndicator.className = `status-indicator status-${stats.status}`;
                statusText.textContent = stats.status === 'running' ? 'Ativo' :
                                        stats.status === 'stopped' ? 'Parado' : 'Erro';

                // Atualiza n√≠vel de √°udio
                const audioLevel = Math.round(stats.current_audio_level * 100);
                document.getElementById('audio-level-fill').style.width = `${audioLevel}%`;
                document.getElementById('audio-level-text').textContent = `${audioLevel}%`;

            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }

        // Fun√ß√£o para atualizar configura√ß√£o
        async function updateConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                document.getElementById('model-name').textContent = config.model || '-';

            } catch (error) {
                console.error('Erro ao atualizar configura√ß√£o:', error);
            }
        }

        // Fun√ß√£o para limpar transcri√ß√µes
        async function clearTranscriptions() {
            if (confirm('Tem certeza que deseja limpar todas as transcri√ß√µes?')) {
                try {
                    await fetch('/api/clear');
                    location.reload();
                } catch (error) {
                    console.error('Erro ao limpar transcri√ß√µes:', error);
                    alert('Erro ao limpar transcri√ß√µes');
                }
            }
        }

        // Event listeners
        document.getElementById('clear-btn').addEventListener('click', clearTranscriptions);

        // Atualiza√ß√£o autom√°tica
        function startAutoUpdate() {
            updateTranscriptions();
            updateStats();
            updateConfig();

            // Atualiza transcri√ß√µes a cada 1 segundo
            setInterval(updateTranscriptions, 1000);

            // Atualiza estat√≠sticas a cada 2 segundos
            setInterval(updateStats, 2000);

            // Atualiza configura√ß√£o a cada 10 segundos
            setInterval(updateConfig, 10000);
        }

        // Inicia quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', startAutoUpdate);
    </script>
</body>
</html>
