#!/usr/bin/env python3
"""
Whisper Real-time Transcriber v2.0
Transcri√ß√£o e tradu√ß√£o de √°udio em tempo real com interface interativa
"""
import argparse
import sys
import multiprocessing as mp
from pathlib import Path

# Configura multiprocessing para evitar problemas no macOS com interfaces gr√°ficas
if sys.platform == "darwin":  # macOS
    mp.set_start_method("fork", force=True)

# Adiciona src ao path para imports
src_path = Path(__file__).parent / "src"
sys.path.insert(0, str(src_path))

from src.app import create_app
from src.audio.device_manager import AudioDeviceManager
from src.config.settings import get_config_manager
from src.utils.logger import setup_colored_logging


def create_parser() -> argparse.ArgumentParser:
    """Cria parser de argumentos da linha de comando"""
    parser = argparse.ArgumentParser(
        description="Whisper Real-time Transcriber v2.0 - Transcri√ß√£o e tradu√ß√£o em tempo real",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemplos de uso:
  python main.py                                    # Modo GUI (padr√£o)
  python main.py --list-devices                     # Lista dispositivos de √°udio
  python main.py --model small --language pt        # Modelo small, for√ßa portugu√™s
  python main.py --console --no-translate           # For√ßa modo console sem tradu√ß√£o
  python main.py --device-id 2 --translate-mode google  # Dispositivo espec√≠fico, Google Translate
        """,
    )

    # Dispositivos de √°udio
    audio_group = parser.add_argument_group("Configura√ß√µes de √Åudio")
    audio_group.add_argument(
        "--list-devices",
        action="store_true",
        help="Lista todos os dispositivos de √°udio dispon√≠veis e sai",
    )
    audio_group.add_argument(
        "--device-id",
        type=int,
        metavar="ID",
        help="ID do dispositivo de entrada (use --list-devices para ver os IDs)",
    )
    audio_group.add_argument(
        "--device-name",
        metavar="NOME",
        help="Substring do nome do dispositivo de entrada (ex: BlackHole)",
    )
    audio_group.add_argument(
        "--sample-rate",
        type=int,
        default=16000,
        metavar="RATE",
        help="Taxa de amostragem (default: 16000)",
    )
    audio_group.add_argument(
        "--chunk-seconds",
        type=int,
        default=3,
        metavar="SEC",
        help="Intervalo de processamento em segundos (default: 3)",
    )

    # Transcri√ß√£o
    transcription_group = parser.add_argument_group("Configura√ß√µes de Transcri√ß√£o")
    transcription_group.add_argument(
        "--model",
        default="base",
        metavar="MODEL",
        help="Modelo Whisper (tiny, base, small, medium, large)",
    )
    transcription_group.add_argument(
        "--device",
        default="cpu",
        choices=["cpu", "cuda"],
        help="Dispositivo para processamento (cpu/cuda)",
    )
    transcription_group.add_argument(
        "--language",
        metavar="LANG",
        help="Idioma do √°udio (pt, en, es, fr, etc.) - auto-detecta se n√£o especificado",
    )
    transcription_group.add_argument(
        "--use-vad",
        action="store_true",
        help="Usar detec√ß√£o de atividade de voz (requer webrtcvad)",
    )
    transcription_group.add_argument(
        "--vad-aggressiveness",
        type=int,
        default=2,
        choices=[0, 1, 2, 3],
        help="Agressividade do VAD (0-3, default: 2)",
    )

    # Tradu√ß√£o
    translation_group = parser.add_argument_group("Configura√ß√µes de Tradu√ß√£o")
    translation_group.add_argument(
        "--no-translate",
        action="store_true",
        help="Desabilita tradu√ß√£o (apenas transcri√ß√£o)",
    )
    translation_group.add_argument(
        "--translate-mode",
        default="local",
        choices=["local", "google"],
        help="Modo de tradu√ß√£o (default: local)",
    )
    translation_group.add_argument(
        "--target-language",
        default="pt",
        metavar="LANG",
        help="Idioma de destino para tradu√ß√£o (default: pt)",
    )

    # Interface
    ui_group = parser.add_argument_group("Configura√ß√µes de Interface")
    ui_group.add_argument(
        "--console",
        action="store_true",
        help="For√ßa modo console (fallback sem GUI)",
    )
    ui_group.add_argument(
        "--gui",
        action="store_true",
        help="Inicia interface desktop (aplicativo com janela) - PADR√ÉO",
    )
    ui_group.add_argument(
        "--teleprompter",
        action="store_true",
        help="Modo teleprompter (janela transparente para streaming)",
    )
    ui_group.add_argument(
        "--log-level",
        default="INFO",
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        help="N√≠vel de log (default: INFO)",
    )
    ui_group.add_argument(
        "--no-color", action="store_true", help="Desabilita cores nos logs"
    )

    # Configura√ß√£o
    config_group = parser.add_argument_group("Gerenciamento de Configura√ß√£o")
    config_group.add_argument(
        "--save-config",
        action="store_true",
        help="Salva configura√ß√µes atuais como padr√£o",
    )
    config_group.add_argument(
        "--reset-config",
        action="store_true",
        help="Reseta configura√ß√µes para padr√µes de f√°brica",
    )

    return parser


def apply_cli_args_to_config(args, config_manager):
    """Aplica argumentos da linha de comando √† configura√ß√£o"""
    config = config_manager.config

    # √Åudio
    if args.device_id is not None:
        config.audio.device_id = args.device_id
    if args.device_name:
        config.audio.device_name = args.device_name
    if args.sample_rate:
        config.audio.sample_rate = args.sample_rate
    if args.chunk_seconds:
        config.audio.chunk_seconds = args.chunk_seconds

    # Transcri√ß√£o
    if args.model:
        config.transcription.model_name = args.model
    if args.device:
        config.transcription.device = args.device
    if args.language:
        config.transcription.language = args.language
    if args.use_vad:
        config.transcription.use_vad = True
    if args.vad_aggressiveness:
        config.transcription.vad_aggressiveness = args.vad_aggressiveness

    # Tradu√ß√£o
    if args.no_translate:
        config.translation.enabled = False
    if args.translate_mode:
        config.translation.mode = args.translate_mode
    if args.target_language:
        config.translation.target_language = args.target_language

    # Interface - removido args.simple (n√£o existe mais)
    if args.log_level:
        config.ui.log_level = args.log_level
    if args.no_color:
        config.ui.colored_logs = False


def main():
    """Fun√ß√£o principal"""
    parser = create_parser()
    args = parser.parse_args()

    # Setup inicial de logging
    setup_colored_logging("INFO")

    # Lista dispositivos se solicitado
    if args.list_devices:
        device_manager = AudioDeviceManager()
        device_manager.print_devices()
        return 0

    # Gerenciador de configura√ß√£o
    config_manager = get_config_manager()

    # Reset de configura√ß√£o se solicitado
    if args.reset_config:
        import shutil

        if config_manager.config_file.exists():
            shutil.move(
                str(config_manager.config_file),
                str(config_manager.config_file.with_suffix(".bak")),
            )
        print("‚úÖ Configura√ß√µes resetadas para padr√µes de f√°brica")
        config_manager = get_config_manager()  # Recarrega configura√ß√µes padr√£o

    # Aplica argumentos da linha de comando
    apply_cli_args_to_config(args, config_manager)

    # Salva configura√ß√£o se solicitado
    if args.save_config:
        config_manager.save()
        print("‚úÖ Configura√ß√µes salvas como padr√£o")
        return 0

    # Cria e executa aplica√ß√£o
    try:
        # Verifica modo de interface
        if args.gui:
            # Modo interface desktop
            import threading

            from src.ui.desktop import DesktopInterface

            print("üñ•Ô∏è Iniciando interface desktop...")

            # Cria aplica√ß√£o em modo headless (sem interface terminal)
            app = create_app(use_simple_ui=True, headless=True)

            # Cria interface desktop
            desktop_interface = DesktopInterface(config_manager.config, config_manager=config_manager)

            # Conecta interface desktop √† aplica√ß√£o
            app.set_desktop_interface(desktop_interface)
            desktop_interface.set_app(app)

            # Executa interface desktop (bloqueia at√© janela fechar)
            desktop_interface.run()

        elif args.teleprompter:
            # Modo teleprompter
            print("üì∫ Iniciando modo teleprompter...")
            from src.ui.desktop import DesktopInterface

            # Cria aplica√ß√£o em modo desktop com teleprompter
            app = create_app(use_simple_ui=False, headless=False)

            # Cria interface desktop em modo teleprompter
            desktop_interface = DesktopInterface(
                config_manager.config,
                teleprompter_mode=True
            )

            # Conecta interface √† aplica√ß√£o
            app.set_ui_interface(desktop_interface)

            # Inicia aplica√ß√£o
            try:
                app.run()
            except KeyboardInterrupt:
                print("\nüëã Interrup√ß√£o recebida, finalizando...")
            except Exception as e:
                print(f"\n‚ùå Erro: {e}")
        elif args.console:
            # Modo console for√ßado (fallback)
            print("üñ•Ô∏è Executando em modo console...")
            app = create_app(use_simple_ui=True, headless=False)

            # Executa aplica√ß√£o
            success = app.run()
            return 0 if success else 1
        else:
            # Modo padr√£o: tenta GUI primeiro, console como fallback
            try:
                print("üñ•Ô∏è Iniciando interface desktop...")

                import threading
                from src.ui.desktop import DesktopInterface

                # Cria aplica√ß√£o em modo headless (sem interface terminal)
                app = create_app(use_simple_ui=True, headless=True)

                # Cria interface desktop
                desktop_interface = DesktopInterface(config_manager.config)

                # Conecta interface desktop √† aplica√ß√£o
                app.set_desktop_interface(desktop_interface)
                desktop_interface.set_app(app)

                # Executa interface desktop (bloqueia at√© janela fechar)
                desktop_interface.run()

            except Exception as e:
                print(f"‚ö†Ô∏è N√£o foi poss√≠vel iniciar GUI: {e}")
                print("üñ•Ô∏è Executando em modo console fallback...")

                app = create_app(use_simple_ui=True, headless=False)
                success = app.run()
                return 0 if success else 1

    except KeyboardInterrupt:
        print("\nüëã At√© logo!")
        return 0
    except Exception as e:
        print(f"‚ùå Erro fatal: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
